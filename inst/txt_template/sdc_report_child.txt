```{r lab-sdc, echo=FALSE,warning=FALSE}

obj_i=readRDS(file = "ano_object_parcel_before.rds")
obj_i=suda2(obj_i)
suda_i=obj_i@risk$suda2$disScore

obj_f=readRDS(file = "ano_object_parcel_after.rds")
obj_f=suda2(obj_f)
suda_f=obj_f@risk$suda2$disScore

unit="parcel"

hierarchical=!is.null(obj_i@hhId)
hierarchy="household"
```

# Disclosure risk assessment and anonymization of `r unit`

## Disclosure risk assessment of `r unit`

### Disclosure risk assessment for categorical quasi-identifiers

* **global risk**  

Taking into account the sample weights, the modeled population frequencies yield an average individual risk of  **`r {obj_i@originalRisk$global$risk_pct}`** percent. This can be interpreted as the average probability that a `r unit` is correctly re-identified. 

The threshold for an acceptable level of risk depends on several factors, such as how the dataset is disseminated, and is generally in the range of 1-5%.

Another angle of perceiving the global risk consists of looking the expected number of re-idetification (ER) which is  **`r {obj_i@originalRisk$global$risk_ER}`** `r unit`.

```{r global-risk,echo=FALSE}

GlobRiskTab(obj_i,title = paste0("Initial global risk at ",unit," level"))

```

* **K-anonymity** 

**`r {sum(obj_i@originalRisk$individual[,"fk"]<2)}` observations** (**`r {round(100*sum(obj_i@originalRisk$individual[,"fk"]<2)/nrow(obj_i@originalRisk$individual), digits = 1)}`% of `r unit``**)  violate the 2-anonymity/are unique with respect to their key. This means that the combination of values for the selected key variables is unique in the dataset. Unique `r unit` are considered to have a high risk of being re-identified. **`r {sum(obj_i@originalRisk$individual[,"fk"]<3)}` observations** (**`r {round(100*sum(obj_i@originalRisk$individual[,"fk"]<3)/nrow(obj_i@originalRisk$individual), digits = 1)}`% of `r unit`**) violate 3-anonymat and **`r {sum(obj_i@originalRisk$individual[,"fk"]<5)}` observations** (**`r {round(100*sum(obj_i@originalRisk$individual[,"fk"]<5)/nrow(obj_i@originalRisk$individual), digits = 1)}`% of `r unit`**) violate 5-anonymity.


```{r kanonymity,echo=FALSE,warning=FALSE}
KanoTab(obj_i,levels=2:5,title = paste0("Initial k-annonymity for ",unit)) 

```

* **Probabilistic individual risk**   

The average individual risk of `r unit`  is **`r {round(mean(obj_i@risk$individual[,1])*100,2)}`%**. On the other hand, the greatest individual risk of `r unit` amounts to **`r {round(max(obj_i@risk$individual[,1])*100,2)}`%** and half of the `r unit` have an individual risk lower than **`r {round(quantile(obj_i@risk$individual[,1],0.5)*100,4)}`%** and 10% of `r unit` have an individual risk exceeding **`r {round(quantile(obj_i@risk$individual[,1],0.9)*100,2)}`%**  

```{r, ind-prob-risk,echo=FALSE,warning=FALSE}
RiskIndSUmmary(obj_i,title = glue::glue("Summary of initial individual {unit} level"))

if(max(suda_i,na.rm = TRUE)==0){
  hist(obj_i@risk$individual[,1],main=glue::glue("Distribution of individual risk of {unit}"),cex.main=0.7,
     ylab="Frequency",xlab="risk")
} else {
  
  par(mfrow=c(1,2))
hist(obj_i@risk$individual[,1],main=paste0("Distribution of individual risk of ",unit),cex.main=0.7,
     ylab="Frequency",xlab="risk")
hist(suda_i[suda_i!=0],main=paste0("Distribution of non-zero DIS scores of ",unit),cex.main=0.7,
     ylab="Frequency",xlab="score")
}

```

* **SUDA Risk**  

All `r unit` without a unique key combination, systematically, have a SUDA-DIS score of 0. This number amounts to `r sum(suda_i==0)` in the microdata. The number of `r unit` with a non-zero DIS risk is `r length(suda_i[suda_i!=0])` ( `r round(length(suda_i[suda_i!=0])/sum(suda_i==0)*100,2)` % of holdings). The average score for these holdings is `r round(mean(suda_i[suda_i!=0])*100,2)`% and the maximum DIS score is `r round(max(suda_i[suda_i!=0])*100,2)`%.


`r if(hierarchical==TRUE){glue("* **Hierarchical risk of {hierarchy} from {unit}s**\n 
The global hierarchical disclosure risk of {hierarchy} from {unit} is {round(obj_i@risk$global$hier_risk_pct,4)} %. The expected number of re-identification from the hierarchical structure is {round(obj_i@risk$global$hier_risk_ER)}.")}`

```{r hier-risk,echo=FALSE,eval=hierarchical}
HierRiskSummary(obj_i,title = glue("hierarchical disclosure risk of {hierarchy} from {unit}"))
```


`r if(hierarchical==TRUE){glue::glue(
"At {hierarchy}s level, the average hierarchical disclosure risk from {unit}s i  is **{round(mean(obj_i@risk$individual[,4])*100,2)}**%. On the other hand, the greatest hierarchical disclosure risk of {hierarchy} amounts to **{round(max(obj_i@risk$individual[,4])*100,2)}**% and half of the {hierarchy} have an hierarchical risk lower than **{round(quantile(obj_i@risk$individual[,4],0.5)*100,4)}**% and 10% of {hierarchy} have an hierarchical risk exceeding **{round(quantile(obj_i@risk$individual[,4],0.9)*100,2)}**%")
}`

### Risk measure for continous variables

## Anonymization of the `r unit`

\textcolor{red}{[Describe the main anonymization of categorical variable applied]}


### Anonymization of categorical quasi-identifers

After anonymization, the overall risk dropped by `r round(obj_i@risk$global$risk_pct-obj_f@risk$global$risk_pct,4)` percentage points from `r round(obj_i@risk$global$risk_pct,4)` to `r round(obj_f@risk$global$risk_pct,4)`. As for the expected number of re-identification, it has decreased by `r round((obj_i@risk$global$risk_ER-obj_f@risk$global$risk_ER)/obj_f@risk$global$risk_ER,4)` percent


```{r  ano-global,echo=FALSE,warning=FALSE}

t1 <- GlobRiskTab(obj_i,df=TRUE,title = glue("Initial global risk at {unit} level"))
t2 <- GlobRiskTab(obj_f,df=TRUE,title = glue("Final global risk at {unit} level"))
knitr::kable(list(t1 , t2),caption = "Initial situation(left) vs. final situation(right)") %>%  kable_styling(latex_options = "HOLD_position") %>% column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, background = "#F7DC6F")

```


`r glue::glue(
"After  the anonymization, {sum(obj_f@risk$individual[,\"fk\"]<2)} of {unit}s ({round(100*sum(obj_f@risk$individual[,\"fk\"]<2)/nrow(obj_f@risk$individual), digits = 1)}% of {unit}s )  violate the 2-anonymity,  {sum(obj_f@risk$individual[,\"fk\"]<3)} {unit}s ({round(100*sum(obj_f@risk$individual[,\"fk\"]<3)/nrow(obj_f@risk$individual), digits = 1)}% of {unit}s) violate 3-anonymat and {sum(obj_f@risk$individual[,\"fk\"]<5)} {unit}s ({round(100*sum(obj_f@risk$individual[,\"fk\"]<5)/nrow(obj_f@risk$individual), digits = 1)}%  of {unit}s) violate 5-anonymity.

")`


```{r ano-kano,echo=FALSE,warning=FALSE}

t1=KanoTab(obj_i,df=TRUE,levels=2:5)
t2=KanoTab(obj_f,df=TRUE,levels=2:5)
knitr::kable(list(t1 , t2),caption = "Initial situation(left) vs. final situation(right)")%>%  kable_styling(latex_options = "HOLD_position")%>% column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, background = "#F7DC6F")


if (!is.null(obj_f@localSuppression)){
  plot.localSuppression(obj_f@localSuppression)+theme_classic()+
    theme(legend.position="none",
          axis.text.x=element_text(angle=45))
}

cbind(obj_f@origData[,obj_f@keyVars],obj_f@risk$individual)%>% 
  filter(risk>0.15) %>% arrange(desc(risk)) %>% kbl(align='rccc',caption=glue("{unit}s with final risk greater than 15 percent")) %>%
  kable_classic_2(full_width = F) %>%  kable_styling(latex_options = "HOLD_position")  


```


`r glue::glue("
the greatest individual risk of {unit}s has dropped of {round(max(obj_i@risk$individual[,1])*100-max(obj_f@risk$individual[,1])*100,4)} (from {round(max(obj_i@risk$individual[,1]),4)}% to {round(max(obj_f@risk$individual[,1]),4)}%) . Half of the {unit}s have  now an individual risk lower than  {round(quantile(obj_f@risk$individual[,1],0.5)*100,4)}% and 10% of {unit} have an individual risk exceeding {round(quantile(obj_f@risk$individual[,1],0.9)*100,2)} %
")`


```{r ano-ind-risk,echo=FALSE,warning=FALSE}

t1=RiskIndSUmmary(obj_i,df=TRUE)
t2=RiskIndSUmmary(obj_f,df=TRUE)
knitr::kable(list(t1 , t2),caption = "Initial situation(left) vs. final situation(right)") %>%  kable_styling(latex_options = "HOLD_position") %>% column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, background = "#F7DC6F")

```


`r if(hierarchical==TRUE){glue::glue("
After anonymization, the overall hierarchical risk of identification of {hierarchy}s from {unit}s dropped by {round(obj_i@risk$global$hier_risk_pct-obj_f@risk$global$hier_risk_pct,4)} percentage points from {round(obj_i@risk$global$hier_risk_pct,4)} to {round(obj_f@risk$global$hier_risk_pct,4)}. As for the expected number of re-identification, it has decreased by {round((obj_i@risk$global$hier_risk_ER-obj_f@risk$global$hier_risk_ER)/obj_f@risk$global$hier_risk_ER,4)} %.
")}`

```{r ano-hier-risk, echo=FALSE,eval=hierarchical}

t1=HierRiskSummary(obj_i,dfl=TRUE)
t2=HierRiskSummary(obj_f,dfl=TRUE)
knitr::kable(list(t1 , t2),caption = "Initial situation(left) vs. final situation(right)") %>%  kable_styling(latex_options = "HOLD_position") %>% column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, background = "#F7DC6F")

```


### Anonymization of continous quasi-identifers

\textcolor{red}{[Describe the anonymization measures taken for continous variables]}

### others anonymization measures

\textcolor{red}{[Describe the other anonymization measures applied to the microdata of `r unit` if any]
}


